version: 2
jobs:
  build:
    docker:
      - image: ruby:2.7.3
    steps:
      - checkout
      - run:
          name: Bundle install
          command: |
            gem install bundler:2.2.25
            bundle install --path vendor/bundle
      - run:
          name: Test
          command: bundle exec rspec
      - run:
          name: Coding style
          command: |
            gem install rubocop
            mkdir -p rubocop
            rubocop --format html -o rubocop/rubocop.html || true
      - run:
          name: Notation
          command: |
            gem install rubycritic -v 4.3.2
            rubycritic lib --no-browser
      - run:
          name: Optimization axis
          command: |
            gem install fasterer
            cat << EOF > .fasterer.yml
            exclude_paths:
              - 'vendor/**/*.rb'
            EOF
            fasterer || true
      - run:
          name: Gemfile Security Audit
          command: |
            gem install bundler-audit
            bundle audit --update
      - store_artifacts:
          path: rubocop/rubocop.html
      - store_artifacts:
          path: tmp/rubycritic
